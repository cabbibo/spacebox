<html>

  <head>
    <style>
      body{ margin: 0px; font-family:"GeoSans"; }

      @font-face {
  font-family: "GeoSans";
  src: url("../assests/GeosansLight.ttf");
}
      #songInfo{
        z-index:999;
        color:#fff; 
        text-align:center;
        bottom:20px;
        font-size:30px;
        width:100%;
        position:absolute;
      }


    </style>
  </head>

  <body>

    <div id="container"></div>
    <div id="songInfo"></div>


    <script src="lib/three.js"                  ></script>
    <script src="lib/jquery.min.js"             ></script>
    <script src="lib/TrackballControls.js"      ></script>
    
    
    <script src="lib/AudioTexture.js"           ></script>
    <script src="lib/AudioController.js"        ></script>
    <script src="lib/ObjectControls.js"         ></script>
    
    <script src="lib/PhysicsRenderer.js"              ></script>
    <script src="lib/underscore.js"              ></script>
    <script src="lib/OBJLoader.js"              ></script>
    <script src="ShaderLoader.js"               ></script>
    <script src="Song.js"                       ></script>


    <script src = "RepelerMesh.js"                ></script>
    <script src = "GEM.js"                        ></script>


    <script src = "Wagner/Wagner.js"            ></script>
    <script src = "Wagner/Wagner.base.js"       ></script>
    <script src = "Wagner/ShaderLoader.js"      ></script>
  
  
    <script>

      var loaded = 0;
      var neededToLoad = 3;


      var simulationActive = true;



      WAGNER.vertexShadersPath    = 'Wagner/vertex-shaders';
      WAGNER.fragmentShadersPath  = 'Wagner/fragment-shaders';
      WAGNER.assetsPath           = 'Wagner/assets/';


      var audioController = new AudioController();

      //audioController.mute.gain.value = 0;
      var audio = new Audio();
      
      var source = audioController.ctx.createMediaElementSource(audio);
      source.connect(audioController.gain);
    

      var matcap = THREE.ImageUtils.loadTexture('img/rough-aluminium.jpg');
      var matcapBlood = THREE.ImageUtils.loadTexture('img/blood.jpg');
      var matcapTurq = THREE.ImageUtils.loadTexture('img/turq.jpg');
      var matcapDark = THREE.ImageUtils.loadTexture('img/dark.jpg');

      var uniforms = {


        dT:   { type:"f" , value: 0 },
        time: { type:"f" , value: 0 },
        counter: { type:"f" , value: 0 },
        t_matcap:{ type:"t" , value: matcapDark },
        fingers:{ type:"v3", value:[] },
        t_audio:{type:"t",value:audioController.texture},
       
        repelers:         { type:"v3v" , value:[] },
        radii:            { type:"v3v" , value:[] },
        velocities:       { type:"v3v" , value:[] },
        power:            { type:"v3v" , value:[] },

        

      }

      var G = uniforms;
      var REPELERS = [];
      

      var camera, renderer, scene , controls;
      
      var vs, fs;

      var geometry, material , light;


      var podGeo;
      var pod;
      var objectControls;
      
      var shaders = new ShaderLoader( 'shaders' , 'shaderChunks'   );

      shaders.load( 'vs-rainbow' , 'rainbow' , 'vertex' );
      shaders.load( 'fs-rainbow' , 'rainbow' , 'fragment' );

      shaders.load( 'vs-matcap' , 'matcap' , 'vertex' );
      shaders.load( 'fs-matcap' , 'matcap' , 'fragment' );

      shaders.load( 'ss-fire' , 'fire' , 'simulation' );
      
      shaders.load( 'vs-sem'  , 'sem' , 'vertex' );
      shaders.load( 'fs-sem' , 'sem' , 'fragment' );

      shaders.load( 'vs-flesh'  , 'flesh' , 'vertex' );
      shaders.load( 'fs-flesh' , 'flesh' , 'fragment' );

      /*shaders.load( 'fs-ribbon'   , 'ribbon'      , 'fragment' );
      shaders.load( 'vs-ribbon'   , 'ribbon'      , 'vertex' );*/


      shaders.shaderSetLoaded = function(){

        onLoad();

      }
        
      var OBJLoader = new THREE.OBJLoader();

      OBJLoader.load( 'models/pod.obj' , function( object ){
      
        object.traverse( function ( child ) {
          if ( child instanceof THREE.Mesh ) {

            podGeo = child.geometry;
            podGeo.computeFaceNormals();
           // podGeo.computeVertexNormals();

              /*GEOS[this.geoName] = child.geometry;     
              GEOS[this.geoName].computeFaceNormals();
              GEOS[this.geoName].computeVertexNormals();*/
             // assignUVs( GEOS[this.geoName] );

           }
        }.bind( this ));

        onLoad();
      });

       OBJLoader.load( 'models/octo.obj' , function( object ){
      
        object.traverse( function ( child ) {
          if ( child instanceof THREE.Mesh ) {

            bunnyGeo = child.geometry;
            bunnyGeo.computeFaceNormals();
            bunnyGeo.computeVertexNormals();

              /*GEOS[this.geoName] = child.geometry;     
              GEOS[this.geoName].computeFaceNormals();
              GEOS[this.geoName].computeVertexNormals();*/
             // assignUVs( GEOS[this.geoName] );

           }
        }.bind( this ));

        onLoad();
      });


    
      var geo = new THREE.IcosahedronGeometry( .13 , 1 );

      
      var songParams = [

          {
            title: 'Coronus, The Terminator',
            artist: 'Flying Lotus',
            soundcloudID: 168192066,
            geometry: geo,
            material: 'rainbow',
            uniforms: uniforms
          },

          {
            title: 'Empyrean ( feat. Mendee Ichikawa )',
            artist: 'Mono / Poly',
            soundcloudID: 161988567,
            geometry: geo,
            material: 'rainbow',
            uniforms: uniforms
          },

          {
            title: 'Movement  I , II & III',
            artist: 'Lapalux',
            soundcloudID: 167881505,
            geometry: geo,
            material: 'rainbow',
            uniforms: uniforms
          },

          {
            title: 'Holiday (feat. Jonti)',
            artist: 'Teebs',
            soundcloudID: 137908413,
            geometry: geo,
            material: 'rainbow',
            uniforms: uniforms
          },

           {
            title: 'Austere Coincidences',
            artist: 'My Dry Wet Mess',
            soundcloudID: 66417987,
            geometry: geo,
            material: 'rainbow',
            uniforms: uniforms
          },

          {
            title: 'For Love I Come',
            artist: 'Thundercat',
            soundcloudID: 17068532,
            geometry: geo,
            material: 'rainbow',
            uniforms: uniforms
          },

          {
            title: 'Onward ( Mono / Poly remix )',
            artist: 'Daedelus',
            soundcloudID: 177345046,
            geometry: geo,
            material: 'rainbow',
            uniforms: uniforms
          },

          {
            title: 'The Antidote ( feat. Nai Palm )',
            artist: 'Taylor McFerrin',
            soundcloudID: 143556987,
            geometry: geo,
            material: 'rainbow',
            uniforms: uniforms
          },


      ]

      var songs = [];
      var currentSong =null;
      var songInfo = document.getElementById('songInfo');



      function init(){

        var w = window.innerWidth;
        var h = window.innerHeight;

        camera = new THREE.PerspectiveCamera( 65 , w/h , .1 , 1000 );
        camera.position.z = 1;
        camera.position.y = .5;

        camera.position.y= 160;
        camera.position.z= 180;
        camera.lookAt( new THREE.Vector3() );

        controls = new THREE.TrackballControls( camera );
        scene = new THREE.Scene();

        renderer = new THREE.WebGLRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );

         /*

        POST PROCESSING
        */
        composer = new WAGNER.Composer( renderer, { useRGBA: true } );
	
        bloomPass = new WAGNER.MultiPassBloomPass();
        bloomPass.params.blurAmount = 30;

        FXAAPass = new WAGNER.FXAAPass();
        vignettePass = new WAGNER.Vignette2Pass();
        vignettePass.params.boost = 1.5;
        vignettePass.params.reduction = 2;
        noisePass = new WAGNER.NoisePass();
        noisePass.params.amount = .1;
        noisePass.params.speed = 1;
        ssaoPass = new WAGNER.SSAOPass();
        chromaticAbberationPass = new WAGNER.ChromaticAberrationPass();


        container = document.getElementById( 'container' );
        
        document.body.appendChild( renderer.domElement );
        window.addEventListener( 'resize', onWindowResize , false );
        window.addEventListener( 'keydown', onKeyDown , false );

        onWindowResize();
         depthMaterial = new THREE.MeshBasicMaterial();
        objectControls = new ObjectControls( camera );


        clock = new THREE.Clock();

        //conso

        material = new THREE.ShaderMaterial({

          uniforms:       uniforms,
          vertexShader:   shaders.vertexShaders.rainbow,
          fragmentShader: shaders.fragmentShaders.rainbow,

        });
        pod = new THREE.Mesh( podGeo , material );
        scene.add( pod );
        pod.position.y = -2.85;
        //pod.scale.multiplyScalar( .1 );
        pod.rotation.x = -Math.PI / 2;

        pod.onHoverOver = function(){ console.log('HELLO' ); }
        //objectControls.add( pod );

        console.log( bunnyGeo );

        var vs = shaders.vs[ 'matcap' ];
        var fs = shaders.fs[ 'matcap' ];
  
        material = new THREE.ShaderMaterial({

          uniforms:         uniforms,
          vertexShader:     vs,
          fragmentShader:   fs,
          //shading: THREE.FlatShading,
          side: THREE.DoubleSide

        });

        bunny = new THREE.Mesh( bunnyGeo , material );


      //  bunny = new THREE.Mesh( bunnyGeo , new THREE.MeshNormalMaterial({side:THREE.DoubleSide}) );

        bunny.scale.multiplyScalar( 30.1 );


        scene.add( bunny );


         var g = new THREE.IcosahedronGeometry(.005 , 1 );
        var m = new THREE.MeshBasicMaterial({
          //map:audioController.texture,
          color: 0xffffff
        });


        // Creating the center pulsing mesh
        for(var i = 0; i < 50; i++ ){

          var mesh = new THREE.Mesh( g , m  );
          mesh.target   = new THREE.Vector3();//toCart( 12 , t , p );
          mesh.velocity = new THREE.Vector3();
          mesh.power    = new THREE.Vector3( 1 , 1 , 1);
          mesh.radius   = new THREE.Vector3( 1 , 1 , 1); 

          G.repelers.value.push( mesh.position );
          G.velocities.value.push( mesh.velocity );
          G.power.value.push( mesh.power );
          G.radii.value.push( mesh.radii );

          REPELERS.push( mesh );
          G.fingers.value.push( mesh.position );

          //scene.add( mesh );


        //  var 
          var p = new THREE.Vector3();
          p.x = Math.random()-.5;
          p.y = Math.random()-.5;
          p.z = Math.random()-.5;

          p.normalize();

          mesh.position.copy( p.multiplyScalar( 1 ) );
          mesh.position.y += .6;
         /* mesh.position.x = (Math.random() - .5 ) * .8;
          mesh.position.z = (Math.random() - .5 ) * .8;
          mesh.position.y = (Math.random() - .5 ) * .8 + .6;*/

        }


        t = new THREE.Mesh( new THREE.IcosahedronGeometry( .3 , 6 ) );
        t = new THREE.Mesh( new THREE.CubeGeometry( .5 , .5 , .5 , 60, 60 , 60 ) );
        t.rotation.x = Math.random();
        t.rotation.y = Math.random();
        t.rotation.z = Math.random();

        t.position.y = .6;

        t.updateMatrix();

        console.log( 'REPELS');
        console.log( REPELERS );

        gem = new RepelerMesh( 'Parameters' , t, REPELERS , {
          
          vs: shaders.vertexShaders.flesh,
          fs: shaders.fragmentShaders.flesh,
      
          soul:{

            repulsionPower:     { type:"f" , value: .1, constraints:[-300  , 0] },
            repulsionRadius:     { type:"f" , value: 4. , constraints:[ 0  , 1000] },
            
            repelers:         G.repelers,
            radii:            G.radii,
            velocities:       G.velocities,
            power:            G.power,

          },

          body:{
            //t_refl:{type:"t" , value:reflectionCube},
            //t_refr:{type:"t" , value:reflectionCube },
            custom1:{type:"f" , value:.9 , constraints:[ .8 , 1 ]},
            t_sem:{type:"t" , value: matcapBlood }

          }

        }); 

        gem.soul.reset( gem.t_og.value );
        gem.toggle();

       // gems.push( gem );


        for( var i =0; i < songParams.length; i++ ){

          var params = songParams[i];

          var a = ((i / songParams.length)+.055) * 2 * Math.PI 
          var x = 1.1 * Math.cos( a );
          var y = .4;
          var z = 1.1 * Math.sin(a );
          params.position = new THREE.Vector3( x , y , z );

          console.log( params.position );
          var song = new Song( params );

          songs.push( song );

        }







         songs[0].play();
         //source.mediaElement.play();
      }

      function animate(){


        controls.update();
        objectControls.update();

        G.dT.value = clock.getDelta();
        G.time.value += G.dT.value;
        G.counter.value ++;

        audioController.update();

        for( var i = 0; i < G.repelers.value.length; i++ ){
       
       /*var r1 = u.repelers.value[i];
       var v1 = u.velocities.value[i];*/


         var ind = i / (2 *  G.repelers.value.length); 
         var fI = Math.floor( ind * audioController.analyzer.array.length );
         var p = audioController.analyzer.array[ fI ];

          G.power.value[i].x = p / 256;
      }



        gem.update();
        composer.reset();
    
        composer.render( scene, camera );
       // composer.pass( chromaticAbberationPass );
        composer.pass( bloomPass );
      // composer.pass( zoomPass );
        composer.pass( vignettePass );
       // composer.pass( FXAAPass );
        //composer.pass( noisePass );

        composer.toScreen();


        requestAnimationFrame( animate );


      }

      
       // Resets the renderer to be the proper size
      function onWindowResize(){

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        

        renderer.setSize( window.innerWidth, window.innerHeight );
        composer.setSize( renderer.domElement.width, renderer.domElement.height );
        depthTexture = WAGNER.Pass.prototype.getOfflineTexture( composer.width, composer.height, false );


      }

       function onKeyDown(e){

        console.log( e.keyCode );
        
        if( e.keyCode == 32 ){

          simulationActive = !simulationActive;

        }


      }


      function onLoad(){

        loaded ++;
        
        if( loaded == neededToLoad ){
          init();
          animate();
        }

      }

    </script>

  </body>
</html>
